// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
  // For Docker deployments.
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
  output          = "../src/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Assets, Tags, Inspections & Alerts

model Asset {
  id                     String                  @id @default(cuid(2))
  /**
   * The legacy ID of the asset (maps to `assets.a_id` in the legacy database).
   */
  legacyAssetId          String?
  createdOn              DateTime                @default(now()) @db.Timestamptz()
  modifiedOn             DateTime                @updatedAt @db.Timestamptz()
  setupOn                DateTime?               @db.Timestamptz()
  active                 Boolean                 @default(true)
  name                   String
  product                Product                 @relation(fields: [productId], references: [id])
  productId              String
  tag                    Tag?                    @relation(fields: [tagId], references: [id])
  tagId                  String?                 @unique
  location               String
  placement              String
  serialNumber           String
  inspectionCycle        Int?
  metadata               Json?
  inspectionRoutePoints  InspectionRoutePoint[]
  inspectionRouteId      String?
  consumables            Consumable[]
  inspections            Inspection[]
  alerts                 Alert[]
  setupQuestionResponses AssetQuestionResponse[]
  productRequests        ProductRequest[]
  site                   Site                    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId                 String                  @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client                 Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId               String                  @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([legacyAssetId])
  @@index([clientId])
  @@index([clientId, siteId])
}

model Consumable {
  id                String    @id @default(cuid(2))
  /**
   * The legacy ID of the consumable (maps to `inventory.i_id` in the legacy database).
   */
  legacyInventoryId String?
  createdOn         DateTime  @default(now()) @db.Timestamptz()
  modifiedOn        DateTime  @updatedAt @db.Timestamptz()
  asset             Asset?    @relation(fields: [assetId], references: [id])
  assetId           String?
  product           Product   @relation(fields: [productId], references: [id])
  productId         String
  expiresOn         DateTime? @db.Timestamptz()
  quantity          Int       @default(1)
  site              Site      @relation(fields: [siteId], references: [id])
  siteId            String    @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client            Client    @relation(fields: [clientId], references: [id])
  clientId          String    @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([legacyInventoryId])
  @@index([clientId])
  @@index([clientId, siteId])
}

model Tag {
  id           String   @id @default(cuid(2))
  externalId   String   @unique @default(cuid(2))
  createdOn    DateTime @default(now()) @db.Timestamptz()
  modifiedOn   DateTime @updatedAt @db.Timestamptz()
  serialNumber String
  asset        Asset?
  /**
   * The legacy ID of the tag (maps to `tags.t_id` in the legacy database).
   */
  legacyTagId  String?
  site         Site?    @relation(fields: [siteId], references: [id])
  siteId       String?
  client       Client?  @relation(fields: [clientId], references: [id])
  clientId     String?

  @@index([serialNumber])
  @@index([legacyTagId])
  @@index([clientId])
  @@index([clientId, siteId])
}

model Inspection {
  id                             String                          @id @default(cuid(2))
  /**
   * The legacy ID of the inspection (maps to `logs.log_id` in the legacy database).
   */
  legacyLogId                    String?
  createdOn                      DateTime                        @default(now()) @db.Timestamptz()
  modifiedOn                     DateTime                        @updatedAt @db.Timestamptz()
  asset                          Asset                           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId                        String
  inspector                      Person                          @relation(fields: [inspectorId], references: [id])
  inspectorId                    String                          @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  status                         InspectionStatus                @default(PENDING)
  useragent                      String?
  ipv4                           String?                         @db.Inet()
  ipv6                           String?                         @db.Inet()
  latitude                       Float?
  longitude                      Float?
  locationAccuracy               Float?
  comments                       String?
  responses                      AssetQuestionResponse[]
  alerts                         Alert[]
  completedInspectionRoutePoints CompletedInspectionRoutePoint[]
  site                           Site                            @relation(fields: [siteId], references: [id])
  siteId                         String                          @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client                         Client                          @relation(fields: [clientId], references: [id])
  clientId                       String                          @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([legacyLogId])
  @@index([clientId])
  @@index([clientId, siteId])
}

enum InspectionStatus {
  PENDING
  COMPLETE
}

model InspectionRoute {
  id                    String                 @id @default(cuid(2))
  createdOn             DateTime               @default(now()) @db.Timestamptz()
  modifiedOn            DateTime               @updatedAt @db.Timestamptz()
  name                  String
  description           String?
  inspectionRoutePoints InspectionRoutePoint[]
  site                  Site                   @relation(fields: [siteId], references: [id])
  siteId                String                 @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client                Client                 @relation(fields: [clientId], references: [id])
  clientId              String                 @default(dbgenerated("current_setting('app.current_client_id'::text)"))
  inspectionSessions    InspectionSession[]

  @@index([clientId])
  @@index([clientId, siteId])
}

model InspectionRoutePoint {
  id                             String                          @id @default(cuid(2))
  createdOn                      DateTime                        @default(now()) @db.Timestamptz()
  modifiedOn                     DateTime                        @updatedAt @db.Timestamptz()
  order                          Int
  inspectionRoute                InspectionRoute                 @relation(fields: [inspectionRouteId], references: [id], onDelete: Cascade)
  inspectionRouteId              String
  asset                          Asset                           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId                        String
  completedInspectionRoutePoints CompletedInspectionRoutePoint[]
}

model InspectionSession {
  id                             String                          @id @default(cuid(2))
  createdOn                      DateTime                        @default(now()) @db.Timestamptz()
  modifiedOn                     DateTime                        @updatedAt @db.Timestamptz()
  status                         InspectionSessionStatus         @default(PENDING)
  inspectionRoute                InspectionRoute                 @relation(fields: [inspectionRouteId], references: [id])
  inspectionRouteId              String
  completedInspectionRoutePoints CompletedInspectionRoutePoint[]
  lastInspector                  Person                          @relation(fields: [lastInspectorId], references: [id])
  lastInspectorId                String                          @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  site                           Site                            @relation(fields: [siteId], references: [id])
  siteId                         String                          @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client                         Client                          @relation(fields: [clientId], references: [id])
  clientId                       String                          @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([clientId])
  @@index([clientId, siteId])
}

enum InspectionSessionStatus {
  PENDING
  COMPLETE
  EXPIRED
  CANCELLED
}

model CompletedInspectionRoutePoint {
  id                     String               @id @default(cuid(2))
  createdOn              DateTime             @default(now()) @db.Timestamptz()
  modifiedOn             DateTime             @updatedAt @db.Timestamptz()
  inspectionSession      InspectionSession    @relation(fields: [inspectionSessionId], references: [id], onDelete: Cascade)
  inspectionSessionId    String
  inspectionRoutePoint   InspectionRoutePoint @relation(fields: [inspectionRoutePointId], references: [id], onDelete: Cascade)
  inspectionRoutePointId String
  inspection             Inspection           @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionId           String
}

model AssetQuestion {
  id                                String                             @id @default(cuid(2))
  /**
   * The legacy ID of the asset question (maps to `questions.q_id` in the legacy database).
   */
  legacyQuestionId                  String?
  createdOn                         DateTime                           @default(now()) @db.Timestamptz()
  modifiedOn                        DateTime                           @updatedAt @db.Timestamptz()
  active                            Boolean                            @default(true)
  type                              AssetQuestionType
  tone                              String?
  required                          Boolean                            @default(false)
  order                             Int?
  prompt                            String
  valueType                         AssetQuestionResponseType
  helpText                          String?
  placeholder                       String?
  selectOptions                     Json?
  /**
   * @deprecated
   */
  productCategory                   ProductCategory?                   @relation(fields: [productCategoryId], references: [id])
  /**
   * @deprecated
   */
  productCategoryId                 String?
  /**
   * @deprecated
   */
  product                           Product?                           @relation(fields: [productId], references: [id])
  /**
   * @deprecated
   */
  productId                         String?
  parentQuestion                    AssetQuestion?                     @relation("AssetQuestionVariants", fields: [parentQuestionId], references: [id], onDelete: Cascade)
  parentQuestionId                  String?
  regulatoryCodes                   RegulatoryCode[]
  files                             File[]
  variants                          AssetQuestion[]                    @relation("AssetQuestionVariants")
  conditions                        AssetQuestionCondition[]
  assetAlertCriteria                AssetAlertCriterion[]
  responses                         AssetQuestionResponse[]
  consumableConfig                  ConsumableQuestionConfig?          @relation(fields: [consumableConfigId], references: [id])
  consumableConfigId                String?
  setAssetMetadataConfig            SetAssetMetadataConfig?
  clientAssetQuestionCustomizations ClientAssetQuestionCustomization[]
  client                            Client?                            @relation(fields: [clientId], references: [id])
  clientId                          String?

  @@index([legacyQuestionId])
}

model File {
  id              String         @id @default(cuid(2))
  createdOn       DateTime       @default(now()) @db.Timestamptz()
  modifiedOn      DateTime       @updatedAt @db.Timestamptz()
  name            String
  url             String
  assetQuestion   AssetQuestion? @relation(fields: [assetQuestionId], references: [id], onDelete: Cascade)
  assetQuestionId String?
}

model ClientAssetQuestionCustomization {
  id              String        @id @default(cuid(2))
  createdOn       DateTime      @default(now()) @db.Timestamptz()
  modifiedOn      DateTime      @updatedAt @db.Timestamptz()
  assetQuestion   AssetQuestion @relation(fields: [assetQuestionId], references: [id], onDelete: Cascade)
  assetQuestionId String        @unique
  enabled         Boolean       @default(true)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String        @default(dbgenerated("current_setting('app.current_client_id'::text)"))
  site            Site?         @relation(fields: [siteId], references: [id])
  siteId          String?

  @@index([clientId])
}

model SetAssetMetadataConfig {
  id              String         @id @default(cuid(2))
  createdOn       DateTime       @default(now()) @db.Timestamptz()
  modifiedOn      DateTime       @updatedAt @db.Timestamptz()
  assetQuestion   AssetQuestion? @relation(fields: [assetQuestionId], references: [id], onDelete: Cascade)
  assetQuestionId String?        @unique
  metadata        Json
}

model AssetQuestionResponse {
  id              String        @id @default(cuid(2))
  createdOn       DateTime      @default(now()) @db.Timestamptz()
  modifiedOn      DateTime      @updatedAt @db.Timestamptz()
  value           Json
  originalPrompt  String
  assetQuestion   AssetQuestion @relation(fields: [assetQuestionId], references: [id])
  assetQuestionId String
  asset           Asset?        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId         String?
  inspection      Inspection?   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionId    String?
  responder       Person        @relation(fields: [responderId], references: [id])
  responderId     String        @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  alerts          Alert[]
  site            Site          @relation(fields: [siteId], references: [id])
  siteId          String        @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client          Client        @relation(fields: [clientId], references: [id])
  clientId        String        @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([clientId])
  @@index([clientId, siteId])
}

enum AssetQuestionType {
  SETUP_AND_INSPECTION
  SETUP
  INSPECTION
}

enum AssetQuestionResponseType {
  BINARY
  INDETERMINATE_BINARY
  TEXT
  TEXTAREA
  DATE
  NUMBER
  SELECT
  IMAGE
}

enum AssetQuestionConditionType {
  REGION
  MANUFACTURER
  PRODUCT_CATEGORY
  PRODUCT
  METADATA
}

model AssetQuestionCondition {
  id              String                     @id @default(cuid(2))
  createdOn       DateTime                   @default(now()) @db.Timestamptz()
  modifiedOn      DateTime                   @updatedAt @db.Timestamptz()
  assetQuestion   AssetQuestion              @relation(fields: [assetQuestionId], references: [id], onDelete: Cascade)
  assetQuestionId String
  conditionType   AssetQuestionConditionType
  value           Json
  description     String?
  client          Client?                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String?
}

model AssetAlertCriterion {
  id              String        @id @default(cuid(2))
  createdOn       DateTime      @default(now()) @db.Timestamptz()
  modifiedOn      DateTime      @updatedAt @db.Timestamptz()
  assetQuestion   AssetQuestion @relation(fields: [assetQuestionId], references: [id], onDelete: Cascade)
  assetQuestionId String
  rule            Json
  alertLevel      AlertLevel    @default(INFO)
  autoResolve     Boolean       @default(false)
  alerts          Alert[]
}

model RegulatoryCode {
  id         String   @id @default(cuid(2))
  createdOn  DateTime @default(now()) @db.Timestamptz()
  modifiedOn DateTime @updatedAt @db.Timestamptz()
  active     Boolean  @default(true) // For soft deletion/archiving old codes

  // Code identification
  codeIdentifier String // e.g., "NFPA 10", "OSHA 1910.151", "ANSI Z358.1"
  title          String // e.g., "Standard for Portable Fire Extinguishers"
  section        String? // Specific section if applicable, e.g., "Section 4.1.2"

  // Governing body information
  governingBody String // e.g., "NFPA", "OSHA", "ANSI", "Local Fire Department"
  jurisdiction  String? // e.g., "Federal", "California", "City of San Francisco"

  // Code details
  description  String? // Brief description of what this code covers
  requirements String? // Specific requirements text

  // Reference information
  sourceUrl       String? // URL to the official code document
  documentVersion String? // Version of the code document
  effectiveDate   DateTime? // When this version became effective
  supersededDate  DateTime? // When this version was superseded (if applicable)

  // Compliance details
  inspectionFrequency String? // e.g., "Monthly", "Annually", "As needed"
  complianceNotes     String? // Additional compliance guidance

  // Relations
  assetQuestions AssetQuestion[]

  @@unique([codeIdentifier, section]) // Prevent duplicate code sections
  @@index([governingBody])
  @@index([active])
}

model Alert {
  id                      String                @id @default(cuid(2))
  /**
   * The legacy ID of the alert (maps to `alerts.alert_id` in the legacy database).
   */
  legacyAlertId           String?
  createdOn               DateTime              @default(now()) @db.Timestamptz()
  modifiedOn              DateTime              @updatedAt @db.Timestamptz()
  alertLevel              AlertLevel            @default(INFO)
  message                 String
  asset                   Asset                 @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId                 String
  inspection              Inspection            @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionId            String
  assetQuestionResponse   AssetQuestionResponse @relation(fields: [assetQuestionResponseId], references: [id])
  assetQuestionResponseId String
  assetAlertCriterion     AssetAlertCriterion   @relation(fields: [assetAlertCriterionId], references: [id], onDelete: Cascade)
  assetAlertCriterionId   String
  resolved                Boolean               @default(false)
  resolvedOn              DateTime?             @db.Timestamptz()
  resolutionNote          String?
  resolvedBy              Person?               @relation(fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedById            String?
  inspectionImageUrl      String?
  site                    Site                  @relation(fields: [siteId], references: [id])
  siteId                  String
  client                  Client                @relation(fields: [clientId], references: [id])
  clientId                String

  @@index([legacyAlertId])
  @@index([clientId])
  @@index([clientId, siteId])
}

enum AlertLevel {
  CRITICAL
  URGENT
  WARNING
  INFO
  AUDIT
}

// Product Requests

model ProductRequest {
  id                      String                   @id @default(cuid(2))
  /**
   * The legacy ID of the product request (maps to `request.rfp_id` in the legacy database).
   */
  legacyRequestId         String?
  createdOn               DateTime                 @default(now()) @db.Timestamptz()
  modifiedOn              DateTime                 @updatedAt @db.Timestamptz()
  status                  ProductRequestStatus     @default(NEW)
  requestor               Person                   @relation(fields: [requestorId], references: [id])
  requestorId             String                   @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  productRequestApprovals ProductRequestApproval[]
  productRequestItems     ProductRequestItem[]
  asset                   Asset?                   @relation(fields: [assetId], references: [id])
  assetId                 String?
  site                    Site                     @relation(fields: [siteId], references: [id])
  siteId                  String                   @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client                  Client                   @relation(fields: [clientId], references: [id])
  clientId                String                   @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([legacyRequestId])
  @@index([clientId])
  @@index([clientId, siteId])
}

enum ProductRequestStatus {
  NEW
  APPROVED
  RECEIVED
  PROCESSING
  FULFILLED
  CANCELLED
  COMPLETE
}

model ProductRequestApproval {
  id               String         @id @default(cuid(2))
  createdOn        DateTime       @default(now()) @db.Timestamptz()
  modifiedOn       DateTime       @updatedAt @db.Timestamptz()
  approved         Boolean
  approver         Person         @relation(fields: [approverId], references: [id])
  approverId       String         @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  productRequest   ProductRequest @relation(fields: [productRequestId], references: [id], onDelete: Cascade)
  productRequestId String
  site             Site           @relation(fields: [siteId], references: [id])
  siteId           String         @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client           Client         @relation(fields: [clientId], references: [id])
  clientId         String         @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([clientId])
  @@index([clientId, siteId])
}

model ProductRequestItem {
  id                  String         @id @default(cuid(2))
  /**
   * The legacy ID of the product request item (maps to `request_items.ri_rfp_id` in the legacy database).
   */
  legacyRequestItemId String?
  createdOn           DateTime       @default(now()) @db.Timestamptz()
  modifiedOn          DateTime       @updatedAt @db.Timestamptz()
  productRequest      ProductRequest @relation(fields: [productRequestId], references: [id], onDelete: Cascade)
  productRequestId    String
  product             Product        @relation(fields: [productId], references: [id])
  productId           String
  quantity            Int
  addedBy             Person         @relation(fields: [addedById], references: [id])
  addedById           String         @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  site                Site           @relation(fields: [siteId], references: [id])
  siteId              String         @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client              Client         @relation(fields: [clientId], references: [id])
  clientId            String         @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([legacyRequestItemId])
  @@index([clientId])
  @@index([clientId, siteId])
}

// Clients, Sites & People

model Address {
  id      String  @id @default(cuid(2))
  street1 String
  street2 String?
  city    String
  state   String?
  zip     String?
  county  String?
  country String?
  client  Client?
  site    Site?
}

model Client {
  id                                String                             @id @default(cuid(2))
  externalId                        String                             @unique @default(cuid(2))
  /**
   * The legacy ID of the client (maps to `clients.c_id` in the legacy database).
   */
  legacyClientId                    String?
  createdOn                         DateTime                           @default(now()) @db.Timestamptz()
  modifiedOn                        DateTime                           @updatedAt @db.Timestamptz()
  status                            ClientStatus                       @default(PENDING)
  startedOn                         DateTime                           @db.Timestamptz()
  name                              String
  address                           Address                            @relation(fields: [addressId], references: [id])
  addressId                         String                             @unique
  phoneNumber                       String
  homeUrl                           String?
  defaultInspectionCycle            Int                                @default(30)
  demoMode                          Boolean                            @default(false)
  sites                             Site[]
  people                            Person[]
  assets                            Asset[]
  consumables                       Consumable[]
  inspections                       Inspection[]
  inspectionRoutes                  InspectionRoute[]
  inspectionSessions                InspectionSession[]
  tags                              Tag[]
  assetQuestions                    AssetQuestion[]
  assetQuestionResponses            AssetQuestionResponse[]
  alerts                            Alert[]
  productRequests                   ProductRequest[]
  productRequestApprovals           ProductRequestApproval[]
  productRequestItems               ProductRequestItem[]
  productCategories                 ProductCategory[]
  manufacturers                     Manufacturer[]
  products                          Product[]
  vaultOwnerships                   VaultOwnership[]
  assetQuestionConditions           AssetQuestionCondition[]
  clientAssetQuestionCustomizations ClientAssetQuestionCustomization[]

  @@index([legacyClientId])
}

enum ClientStatus {
  LEGACY
  PENDING
  ACTIVE
  INACTIVE
}

model Site {
  id                                String                             @id @default(cuid(2))
  externalId                        String                             @unique @default(cuid(2))
  /**
   * The legacy ID of the site (maps to `locations.loc_id` in the legacy database).
   */
  legacySiteId                      String?
  /**
   * The legacy ID of the client group (maps to `groups.group_id` in the legacy database).
   */
  legacyGroupId                     String?
  createdOn                         DateTime                           @default(now()) @db.Timestamptz()
  modifiedOn                        DateTime                           @updatedAt @db.Timestamptz()
  name                              String
  address                           Address                            @relation(fields: [addressId], references: [id])
  addressId                         String                             @unique
  phoneNumber                       String
  primary                           Boolean                            @default(false)
  parentSite                        Site?                              @relation("ParentSiteSubsite", fields: [parentSiteId], references: [id], onDelete: Restrict)
  parentSiteId                      String?
  subsites                          Site[]                             @relation("ParentSiteSubsite")
  assets                            Asset[]
  consumables                       Consumable[]
  productRequests                   ProductRequest[]
  tags                              Tag[]
  people                            Person[]
  inspections                       Inspection[]
  inspectionRoutes                  InspectionRoute[]
  inspectionSessions                InspectionSession[]
  assetQuestionResponses            AssetQuestionResponse[]
  alerts                            Alert[]
  client                            Client                             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId                          String
  productRequestApprovals           ProductRequestApproval[]
  productRequestItems               ProductRequestItem[]
  vaultOwnerships                   VaultOwnership[]
  clientAssetQuestionCustomizations ClientAssetQuestionCustomization[]

  @@index([legacySiteId])
  @@index([legacyGroupId])
  @@index([clientId])
}

model Person {
  id                      String                   @id @default(cuid(2))
  createdOn               DateTime                 @default(now()) @db.Timestamptz()
  modifiedOn              DateTime                 @updatedAt @db.Timestamptz()
  firstName               String
  lastName                String
  email                   String
  username                String?
  idpId                   String?                  @unique
  /**
   * The legacy username of the person (maps to `users.u_name` in the legacy database).
   */
  legacyUsername          String?
  productRequests         ProductRequest[]
  productRequestApprovals ProductRequestApproval[]
  productRequestItems     ProductRequestItem[]
  inspections             Inspection[]
  inspectionSessions      InspectionSession[]
  assetQuestionResponses  AssetQuestionResponse[]
  vaultOwnerships         VaultOwnership[]
  alertsResolved          Alert[]
  site                    Site                     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId                  String
  client                  Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId                String

  @@index([legacyUsername])
  @@index([clientId])
  @@index([clientId, siteId])
}

// Products

model ProductCategory {
  id               String          @id @default(cuid(2))
  /**
   * The legacy ID of the product category (maps to `category.cat_id` in the legacy database).
   */
  legacyCategoryId String?
  createdOn        DateTime        @default(now()) @db.Timestamptz()
  modifiedOn       DateTime        @updatedAt @db.Timestamptz()
  active           Boolean         @default(true)
  name             String
  shortName        String?
  description      String?
  icon             String?
  color            String?
  /**
   * @deprecated
   */
  assetQuestions   AssetQuestion[]
  products         Product[]
  client           Client?         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId         String?

  @@index([legacyCategoryId])
}

model Manufacturer {
  id                   String    @id @default(cuid(2))
  /**
   * The legacy ID of the manufacturer (maps to `manufacturers.mfg_id` in the legacy database).
   */
  legacyManufacturerId String?
  createdOn            DateTime  @default(now()) @db.Timestamptz()
  modifiedOn           DateTime  @updatedAt @db.Timestamptz()
  active               Boolean   @default(true)
  name                 String
  homeUrl              String?
  products             Product[]
  client               Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId             String?

  @@index([legacyManufacturerId])
}

model AnsiCategory {
  id          String   @id @default(cuid(2))
  createdOn   DateTime @default(now()) @db.Timestamptz()
  modifiedOn  DateTime @updatedAt @db.Timestamptz()
  name        String
  description String?
  color       String?
  icon        String?

  products Product[]
}

model Product {
  id                  String                     @id @default(cuid(2))
  /**
   * The legacy ID of the product (maps to `products.p_id` in the legacy database).
   */
  legacyProductId     String?
  /**
   * The legacy ID of the consumable product (maps to `consumables.con_id` in the legacy database).
   */
  legacyConsumableId  String?
  createdOn           DateTime                   @default(now()) @db.Timestamptz()
  modifiedOn          DateTime                   @updatedAt @db.Timestamptz()
  active              Boolean                    @default(true)
  manufacturer        Manufacturer               @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  manufacturerId      String
  type                ProductType
  name                String
  description         String?
  sku                 String?
  productUrl          String?
  imageUrl            String?
  productCategory     ProductCategory            @relation(fields: [productCategoryId], references: [id], onDelete: Cascade)
  productCategoryId   String
  parentProduct       Product?                   @relation("PrimaryConsumableProduct", fields: [parentProductId], references: [id], onDelete: Cascade)
  parentProductId     String?
  consumableProducts  Product[]                  @relation("PrimaryConsumableProduct")
  quantity            Int?
  price               Float?
  ansiCategory        AnsiCategory?              @relation(fields: [ansiCategoryId], references: [id])
  ansiCategoryId      String?
  perishable          Boolean                    @default(false)
  ansiMinimumRequired Boolean                    @default(false)
  assets              Asset[]
  consumables         Consumable[]
  productRequestItems ProductRequestItem[]
  /**
   * @deprecated
   */
  assetQuestions      AssetQuestion[]
  consumableConfigs   ConsumableQuestionConfig[]
  client              Client?                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId            String?

  @@index([legacyProductId])
  @@index([legacyConsumableId])
}

enum ProductType {
  CONSUMABLE
  PRIMARY
}

model ConsumableQuestionConfig {
  id                  String                @id @default(cuid(2))
  createdOn           DateTime              @default(now()) @db.Timestamptz()
  modifiedOn          DateTime              @updatedAt @db.Timestamptz()
  consumableProduct   Product               @relation(fields: [consumableProductId], references: [id])
  consumableProductId String
  mappingType         ConsumableMappingType
  assetQuestions      AssetQuestion[]
}

enum ConsumableMappingType {
  EXPIRATION_DATE
}

model SettingsBlock {
  id         String   @id @default(cuid(2))
  createdOn  DateTime @default(now()) @db.Timestamptz()
  modifiedOn DateTime @updatedAt @db.Timestamptz()
  friendlyId String   @unique
  data       Json
}

model VaultOwnership {
  id         String          @id @default(cuid(2))
  createdOn  DateTime        @default(now()) @db.Timestamptz()
  modifiedOn DateTime        @updatedAt @db.Timestamptz()
  key        String          @unique
  bucketName String?
  accessType VaultAccessType @default(CLIENT_OWNER)
  owner      Person          @relation(fields: [ownerId], references: [id])
  ownerId    String          @default(dbgenerated("current_setting('app.current_person_id'::text)"))
  site       Site            @relation(fields: [siteId], references: [id])
  siteId     String          @default(dbgenerated("current_setting('app.current_site_id'::text)"))
  client     Client          @relation(fields: [clientId], references: [id])
  clientId   String          @default(dbgenerated("current_setting('app.current_client_id'::text)"))

  @@index([clientId])
  @@index([clientId, siteId])
}

enum VaultAccessType {
  PUBLIC
  CLIENT
  CLIENT_SITE
  CLIENT_OWNER
  STRICT_OWNER
}

model SigningKey {
  id        String    @id @default(cuid(2))
  createdOn DateTime  @default(now()) @db.Timestamptz()
  keyId     String    @unique
  keySecret String    @unique @default(cuid(2))
  expiredOn DateTime? @db.Timestamptz()
}
